#!/bin/bash

# Service name:      sleep_monitor
# Place in:          /userdata/system/services
# Make executable:   chmod +x sleep_monitor
# Usage:             batocera-services enable sleep_monitor

SERVICE_STATE="${1}"
LID_STATE_FILE="/proc/acpi/button/lid/LID0/state"
CHECK_INTERVAL=5  # seconds

monitor_loop() {
    while true; do
        if grep -q 'closed' "${LID_STATE_FILE}"; then
            echo "Lid closed detected â€” shutting down"
            poweroff
        fi
        sleep "${CHECK_INTERVAL}"
    done
}

case "${SERVICE_STATE}" in
    start)
        echo "Starting sleep-monitor service..."
        monitor_loop &
        ;;
    stop)
        echo "Stopping sleep-monitor service..."
        pkill -f sleep_monitor
        ;;
    *)
        echo "Usage: $0 start|stop"
        exit 1
        ;;
esac
